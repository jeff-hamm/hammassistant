# Home Assistant Docker Setup - Migrated from HAOS VM
# Migrated on: 2025-12-11
#
# IMPORTANT: Before starting these containers, ensure:
#   1. The hammassistant VM is STOPPED (virsh destroy hammassistant)
#   2. USB devices will become available on host after VM shutdown
#
# USB Devices:
#   - Z-Wave: Zooz 800 Z-Wave Stick (1a86:55d4) -> /dev/ttyACM0
#   - Bluetooth: TP-Link Bluetooth USB Adapter (2357:0604)
#
# Networking:
#   - Uses host networking mode for full Bluetooth/USB access
#   - Home Assistant will be accessible at host IP on port 8123
#   - All services share the host network namespace
#
# Usage:
#   cd /mnt/pool/appdata/hammassistant-new
#   docker compose up -d
#   docker compose logs -f homeassistant
#
# Original HAOS addons migrated:
#   - Z-Wave JS UI (a0d7b954_zwavejs2mqtt)
#   - Zigbee2MQTT (45df7312_zigbee2mqtt) - Uses remote coordinator at 192.168.1.174:6638
#   - Mosquitto broker (core_mosquitto)
#   - ESPHome (5c53de3b_esphome)
#   - Matter Server (core_matter_server)
#   - Cloudflared (9074a9fa_cloudflared)
#   - NetDaemon V5 (c6a2317c_netdaemon5)
#   - Whisper/Piper/OpenWakeWord (voice assistant stack)

services:
  # ============================================
  # Home Assistant Core
  # ============================================
  homeassistant:
    container_name: hammassistant
    hostname: hammassistant
    image: ghcr.io/home-assistant/home-assistant:latest
    restart: unless-stopped
    privileged: true
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_ADMIN
    network_mode: host
    environment:
      - TZ=${TZ}
    volumes:
      - ${COMPOSE_ROOT}/config:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:rw  # Must be read-write for Bluetooth
      - /mnt/user/jumpdrive:/share/jumpdrive  # For yt_dlp
    devices:
      - /dev/bus/usb/003/004:/dev/bus/usb/003/004  # TP-Link Bluetooth USB Adapter
    # Bluetooth via USB passthrough
    # Device: TP-Link Bluetooth USB Adapter (2357:0604)
    # Requires NET_ADMIN, NET_RAW, and SYS_ADMIN capabilities for full BLE support
    # dbus must be mounted read-write for BlueZ access
    # depends_on:
    #   - mosquitto
    #   - zwavejs
    #   - zigbee2mqtt

  # ============================================
  # MQTT Broker
  # ============================================
  mosquitto:
    container_name: mosquitto
    image: eclipse-mosquitto:2
    restart: unless-stopped
    network_mode: host
    # ports:
    #   - "1883:1883"
    #   - "9001:9001"
    volumes:
      - ${COMPOSE_ROOT}/mosquitto/config:/mosquitto/config
      - ${COMPOSE_ROOT}/mosquitto/data:/mosquitto/data
      - ${COMPOSE_ROOT}/mosquitto/log:/mosquitto/log
    environment:
      - TZ=${TZ}

  # ============================================
  # MQTT Explorer (Web UI)
  # ============================================
  mqtt-explorer:
    container_name: mqtt-explorer
    image: smeagolworms4/mqtt-explorer:browser-1.0.3
    restart: unless-stopped
    # Runs on bridge networking and publishes a host port.
    ports:
      - "4000:4000"
    volumes:
      - ${COMPOSE_ROOT}/mqtt-explorer:/mqtt-explorer/config
    environment:
      - TZ=${TZ}
      - HTTP_PORT=4000
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - mosquitto

  # ============================================
  # Z-Wave JS UI
  # ============================================
  zwavejs:
    container_name: zwavejs
    image: zwavejs/zwave-js-ui:latest
    restart: unless-stopped
    network_mode: host
    # ports:
    #   - "8091:8091"   # Web UI
    #   - "3000:3000"   # WebSocket for HA
    environment:
      - TZ=${TZ}
    volumes:
      - ${COMPOSE_ROOT}/zwavejs:/usr/src/app/store
    devices:
      # Zooz 800 Z-Wave Stick (1a86:55d4) -> /dev/ttyACM0
      # Udev rule creates /dev/zwave symlink for convenience
      # Udev rule location: /etc/udev/rules.d/99-zwave-stick.rules
      # Boot install script: /mnt/pool/appdata/home/boot.d/30-zwave-udev-rule.sh
      - /dev/zwave:/dev/zwave
    tty: true
    stop_signal: SIGINT

  # ============================================
  # Zigbee2MQTT
  # Uses remote coordinator at 192.168.1.174:6638 (no local USB)
  # ============================================
  zigbee2mqtt:
    container_name: zigbee2mqtt
    image: koenkk/zigbee2mqtt:latest
    restart: unless-stopped
    network_mode: host
    # ports:
    #   - "8099:8099"   # Web frontend
    environment:
      - TZ=${TZ}
    volumes:
      - ${COMPOSE_ROOT}/config/zigbee2mqtt:/app/data
    depends_on:
      - mosquitto

  # ============================================
  # ESPHome
  # ============================================
  esphome:
    container_name: esphome
    image: ghcr.io/esphome/esphome:latest
    restart: unless-stopped
    network_mode: host
    # ports:
    #   - "6052:6052"   # Web dashboard
    environment:
      - TZ=${TZ}
      - ESPHOME_DASHBOARD_USE_PING=true
    volumes:
      - ${COMPOSE_ROOT}/esphome:/config
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - homeassistant

  # ============================================
  # Matter Server
  # ============================================
  matter-server:
    container_name: matter-server
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    restart: unless-stopped
    network_mode: host
    # ports:
    #   - "5580:5580"   # Matter server API
    security_opt:
      - apparmor=unconfined
    volumes:
      - ${COMPOSE_ROOT}/matter-server:/data
      - /run/dbus:/run/dbus:ro
    environment:
      - TZ=${TZ}
    depends_on:
      - homeassistant

  # ============================================
  # NetDaemon V5 (.NET 9)
  # ============================================
  netdaemon:
    container_name: netdaemon
    image: netdaemon/netdaemon5:latest
    restart: unless-stopped
    network_mode: host
    profiles:
      - netdaemon
    environment:
      - TZ=${TZ}
      - HOMEASSISTANT__HOST=localhost
      - HOMEASSISTANT__PORT=8123
      - HOMEASSISTANT__TOKEN=${HA_TOKEN}
      - NetDaemon__ApplicationAssembly=/data/Hammassistant.dll
      - Logging__LogLevel__Default=Information
    volumes:
      - ${COMPOSE_ROOT}/netdaemon:/data
    depends_on:
      - homeassistant

  # ============================================
  # Voice Assistant Stack
  # ============================================
  whisper:
    container_name: whisper
    image: rhasspy/wyoming-whisper:latest
    restart: unless-stopped
    network_mode: host
    profiles:
      - voice-assistant
    # ports:
    #   - "10300:10300"
    command: --model small-int8 --language en
    environment:
      - TZ=${TZ}
    volumes:
      - ${COMPOSE_ROOT}/whisper:/data
    depends_on:
      - homeassistant

  piper:
    container_name: piper
    image: rhasspy/wyoming-piper:latest
    restart: unless-stopped
    profiles:
      - voice-assistant
    network_mode: host
    # ports:
    #   - "10200:10200"
    command: --voice en_US-lessac-medium
    environment:
      - TZ=${TZ}
    volumes:
      - ${COMPOSE_ROOT}/piper:/data
    depends_on:
      - homeassistant

  openwakeword:
    container_name: openwakeword
    image: rhasspy/wyoming-openwakeword:latest
    restart: unless-stopped
    network_mode: host
    profiles:
      - voice-assistant
    # ports:
    #   - "10400:10400"
    command: --preload-model ok_nabu
    environment:
      - TZ=${TZ}
    depends_on:
      - homeassistant