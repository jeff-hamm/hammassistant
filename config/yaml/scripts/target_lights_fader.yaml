target_lights_fader:
  alias: Target Lights Fader
  description: >
    Fades a lamp over time. If you have any questions or comments about this
    script, feel free to tweet Ashley Bischoff at @FriendlyAshley. Released under
    the Apache 2.0 license. (v2.0)
  fields:
    lights:
      name: ðŸ’¡ Lights
      description: entity_id of the lamp.
      selector:
        target:
      example: light.kitchen
      required: true
    lampBrightnessScale:
      name: The lampâ€™s internal brightness scale
      description: >
        Most lamps seem to internally use a 0 to 255 brightness scale, but some
        lamps internally use a 0% to 100% brightness scale. Either of these
        settings will still fade the lamp, but if you happen to match this setting
        to the lampâ€™s internal brightness scale, the resulting fade may be
        smoother. (If youâ€™re not sure, you can just leave this as is.)
      advanced: true
      required: true
      selector:
        select:
          options:
            - label: 0% to 100%
              value: zeroToOneHundred
            - label: 0 to 255
              value: zeroToTwoFiftyFive
      default: zeroToTwoFiftyFive
    transitionTime:
      name: â± Fade time
      description: Fade duration.
      selector:
        duration: null
      required: true
    easingTypeInput:
      name: ðŸ“‰ Easing type
      description: >-
        The easing function that youâ€™d like the fade to use. As a starting
        pointâ€”you canâ€™t go wrong with any of the â€œEase-In-Out Xâ€ easings as those
        will always look pretty good whenever youâ€™re fading between two nonzero
        brightness values. As well, the â€œEase-Out Xâ€ easings often tend to look
        good if you might be fading up very quickly from zero to another
        brightness, and the â€œEase-In Xâ€ easings are mostly only included for
        completeness as those tend to only look good if you might be fading down
        to zero very quickly. (See also https://easings.net for visual demos of
        each of these easing types.)
      selector:
        select:
          mode: list
          options:
            - label: Try to automatically select the easing type
              value: auto
            - label: Ease-In-Out Sine [a good all-rounder]
              value: easeInOutSine
            - label: Ease-In-Out Quad
              value: easeInOutQuad
            - label: Ease-In-Out Cubic
              value: easeInOutCubic
            - label: Ease-In-Out Quart
              value: easeInOutQuart
            - label: Ease-Out Sine
              value: easeOutSine
            - label: Ease-Out Quad
              value: easeOutCubic
            - label: Ease-Out Cubic
              value: easeOutCubic
            - label: Ease-Out Quart
              value: easeOutQuart
            - label: Ease-In Sine
              value: easeInSine
            - label: Ease-In Quad
              value: easeInCubic
            - label: Ease-In Cubic
              value: easeInCubic
            - label: Ease-In Quart
              value: easeInQuart
            - label: Linear [somewhat unnatural to the human eye; not recommended]
              value: linear
      default: auto
      required: true
    endBrightnessPercent:
      name: End brightness level
      description: Percentage from 0 to 100 representing the final brightness level.
      selector:
        number:
          min: 0
          max: 100
          step: 1
          mode: slider
          unit_of_measurement: "%"
      default: 0
      example: "50"
      required: true
    endBrightnessEntity:
      name: (optional) Use an entity instead for the end-brightness value?
      description: >-
        You can optionally have the script ignore the end-brightness value above
        and instead use the numeric value of anonther entity that you select here,
        such as an input-number helper, an input-select helper, an input-text
        helper, or a numeric sensor.
      selector:
        entity:
          domain:
            - input_number
            - input_select
            - input_text
            - sensor
      example: input_number.dining_room_entertaining_level
      required: false
      advanced: true
    endBrightnessEntityScale:
      name: The end-brightness entityâ€™s brightness scale (if used)
      description: >-
        If you enable the â€œuse an entity for the end-brightness value insteadâ€
        option, select here whether your chosen entity represents brightness with
        a 0% to 100% scale or a 0 to 255 scale. (Noteâ€”in either case, this script
        will expect that entity to solely have an integer value without any
        nonnumeric characters such as â€œ%â€.)
      advanced: true
      selector:
        select:
          options:
            - label: 0% to 100%
              value: zeroToOneHundred
            - label: 0 to 255
              value: zeroToTwoFiftyFive
      default: zeroToOneHundred
      required: true
    endColorTemperatureKelvin:
      name: ðŸŽ¨ (optional) End color temperature (in Kelvin)
      description: >-
        Color temperature from 2000 K to 6500 K representing the final color
        temperature.
      selector:
        number:
          min: 2000
          max: 6500
          step: 50
          mode: slider
          unit_of_measurement: Â°K
      example: "2700"
      required: false
    endColorTemperatureKelvinEntity:
      name: (optional) Use an entity instead for the ending Kelvin value?
      description: >-
        You can optionally have the script ignore the end-color-temperature value
        above and instead use the numeric value of anonther entity that you select
        here, such as an input-number helper, an input-select helper, an
        input-text helper, or a numeric sensor.
      selector:
        entity:
          domain:
            - input_number
            - input_select
            - input_text
            - sensor
      example: input_number.dining_room_color_temperature
      required: false
      advanced: true
    autoCancelThreshold:
      name: ðŸš« (optional) Brightness-change threshold that auto-cancels the fade
      description: >-
        You can optionally have the script automatically cancel its fade if the
        lampâ€™s brightness were to be manually changed by a certain amount. For
        example, letâ€™s suppose that you were to set this value to 5% and then you
        were to run this script. If there comes a point within the fade where this
        script is expecting the lamp to be at, say, 22% brightnessâ€”but youâ€™ve just
        manually set that lamp to 30% brightnessâ€”this script will automatically
        cancel its fade since that 8% difference is >= 5%. Noteâ€”if you use this,
        Ashley doesnâ€™t recommend setting this to anything less than about 3;
        thatâ€™s just because it can be normal for there to be an occasional
        difference of 1 or 2 since not all lamps instantly reflect newly assigned
        brightness values due to processing lag and other factors. In Ashleyâ€™s
        home, she personally uses a value of about 5 for this.
      selector:
        number:
          min: 2
          max: 100
          step: 1
          mode: slider
          unit_of_measurement: "%"
      example: "10"
      required: false
    shouldStopIfTheLampIsTurnedOffDuringTheFade:
      name: â¤µï¸ Cancel the fade if the lamp is turned off during the fade?
      description: >-
        By default, the script will automatically disengage if the lamp is turned
        off during the fade. But if youâ€™d like to, you can also disable that
        behavior with this switch. (And donâ€™t worryâ€”this feature is smart enough
        to not automatically cancel the fade at points when the lampâ€™s intended
        brightness might be zero, such as if the script were to be fading down to
        zero or fading up from zero.)
      selector:
        boolean: null
      advanced: false
      required: true
      default: true
    stopEntity:
      name: ðŸ›‘ (optional) Stop if a certain entity is turned on during the fade?
      description: >-
        You can optionally have the script keep an eye on an input boolean or a
        binary sensor or a light. And if that entity is then turned on during the
        fade, the script will automatically stop. So for example, if you create a
        â€œStop Everythingâ€ input boolean, and if you set that entity here, you can
        stop your fade at any time by turning on that â€œStop Everythingâ€ entity. 
      selector:
        entity:
          domain:
            - input_boolean
            - binary_sensor
            - light
            - switch
      example: input_boolean.stop_everything
      required: false
      advanced: true
    shouldResetTheStopEntityToOffAtStart:
      name: (optional) Reset that â€œstopâ€ entity to off just before starting the fade?
      description: >-
        If you make use of the stop entity (above), you can also optionally have
        the script automatically reset that entity to â€œoffâ€ at the start of the
        fade. (By default, the script wonâ€™t change the value of the stop entity.)
      selector:
        boolean: null
      advanced: true
      required: true
      default: false
    shouldInvertTheValueOfTheStopEntity:
      name: (optional) Stop only if the â€œstopâ€ entity is instead turned OFF?
      description: >-
        If you make use of the stop entity (above), you can optionally have the
        script automatically stop only if that entity is turned OFF during the
        fade.
      selector:
        boolean: null
      advanced: true
      required: true
      default: false
    minimumStepDelayInMilliseconds:
      name: Minimum delay per step
      description: >-
        The minimum delay between sending each brightness command. Some lamps only
        accept commands every X millisecondsâ€”so while you can probably leave this
        as is, if by chance your lamp were to behave strangely, you might try
        bumping up this number by another ten or twenty milliseconds.
      advanced: true
      selector:
        number:
          min: 50
          max: 1000
          step: 10
          mode: slider
          unit_of_measurement: ms
      default: 50
      example: "100"
    shouldTryToUseNativeLampTransitionsToo:
      name: ðŸ§ª (experimental) If available, use the lamp's native transitions too?
      description: >-
        If this is enabled and if the lamp natively supports transitions, the
        script will make use of the lampâ€™s native transition effect when moving between
        brightness steps or color steps if those steps are very gradually spaced.
        When enabled, this has the possibility of offering even smoother fades.
        And if the lamp doesnâ€™t happen to support the transition effect in the
        first place, this feature will automatically disengage. (And while Ashley
        feels comfortable using this feature in her own house, this feature isnâ€™t
        as thoroughly tested as the scriptâ€™s other features, so this feature is
        considered experimental for now.)
      selector:
        boolean: null
      advanced: true
      required: true
      default: true
    isDebugMode:
      name: ðŸ› Enable debugging mode?
      description: >-
        If this is enabled, the script will output status messages to your Home
        Assistant log along the way. Unless something were to be acting weirdly,
        you can leave this off.
      selector:
        boolean: null
      advanced: true
      required: true
      default: false
  sequence:
    - action: script.get_target_lights
      data:
        lights_sources: '{{ lights }}'
        domain: light.
      response_variable: light_entities
    - repeat:
        for_each: '{{ light_entities.entities }}'
        sequence:
          - action: script.ashley_s_light_fader
            data:
              light: '{{ repeat.item }}'
              lampBrightnessScale: '{{ lampBrightnessScale }}'
              transitionTime: '{{ transitionTime }}'
              easingTypeInput: '{{ easingTypeInput }}'
              endBrightnessPercent: '{{ endBrightnessPercent }}'
              endBrightnessEntity: '{{ endBrightnessEntity }}'
              endBrightnessEntityScale: '{{ endBrightnessEntityScale }}'
              endColorTemperatureKelvin: '{{ endColorTemperatureKelvin }}'
              endColorTemperatureKelvinEntity: '{{ endColorTemperatureKelvinEntity }}'
              autoCancelThreshold: '{{ autoCancelThreshold }}'
              shouldStopIfTheLampIsTurnedOffDuringTheFade: '{{ shouldStopIfTheLampIsTurnedOffDuringTheFade }}'
              stopEntity: '{{ stopEntity }}'
              shouldResetTheStopEntityToOffAtStart: '{{ shouldResetTheStopEntityToOffAtStart }}'
              shouldInvertTheValueOfTheStopEntity: '{{ shouldInvertTheValueOfTheStopEntity }}'
              minimumStepDelayInMilliseconds: '{{ minimumStepDelayInMilliseconds }}'
              shouldTryToUseNativeLampTransitionsToo: '{{ shouldTryToUseNativeLampTransitionsToo }}'
              isDebugMode: '{{ isDebugMode }}'      
  mode: parallel
  max: 15
  icon: mdi:lightbulb-on-50
